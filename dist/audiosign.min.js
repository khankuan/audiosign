var AudioSignUtil={integerToBinaryArray:function(a,b){for(var c=[],d=a.toString(2),e=0;b>e;e++)c.push("1"==d[d.length-1-e]?1:0);return c.reverse()},binaryArrayToInteger:function(a){for(var b=1,c=0,d=0;d<a.length;d++)a[a.length-1-d]>=.5&&(c+=b),b*=2;return c}},AudioSignBroadcaster=function(a){var b=this;a=a||{};var c=a.size||32,d=a.step||80,e=a.baseFrequency||19e3-d*c;if(0==a.id||a.id==Math.pow(2,c)-1)throw new Error("Invalid Id");this.id=a.id||Math.floor(Math.random()*Math.pow(2,c)),this.binaryArrayId=AudioSignUtil.integerToBinaryArray(this.id,c),window.AudioContext=AudioContext||webkitAudioContext,window.audioSignAudioContext=window.audioSignAudioContext||new AudioContext,this._startBuffer=function(){b._sound=audioSignAudioContext.createBufferSource(),b._sound.loop=!0,b._sound.connect(audioSignAudioContext.destination);for(var a=1*audioSignAudioContext.sampleRate,f=audioSignAudioContext.createBuffer(1,a,audioSignAudioContext.sampleRate),g=f.getChannelData(0),h=0,i=0;c>i;i++)if(this.binaryArrayId[i]>0){h+=1;for(var j=0;a>j;j++)g[j]+=Math.sin(2*Math.PI*(e+i*d)*j/audioSignAudioContext.sampleRate)}for(var i=0;a>i;i++)g[i]/=h;b._sound.buffer=f,b._sound.start(0)}};AudioSignBroadcaster.prototype.start=function(){if("Started"==this._state)throw new Error("Already started");this._state="Started",this._startBuffer()},AudioSignBroadcaster.prototype.stop=function(){if("Started"!=this._state)throw new Error("Not started");this._sound.stop(),delete this._sound,delete this._state};var AudioSignListener=function(a){var b=this;a=a||{};var c=a.size||32,d=a.step||80,e=a.diminishingFactor||.95,f=a.threshold||.2,g=a.candidateFoundStreak||40,h=19e3-d*c||a.baseFrequency;this._listeners={},window.AudioContext=AudioContext||webkitAudioContext,window.audioSignAudioContext=window.audioSignAudioContext||new AudioContext;var i,j,k,l;this._reset=function(){i=[],j=void 0,k=0,l=void 0},this._emit=function(a,b){for(var c in this._listeners[a])this._listeners[a][c]&&this._listeners[a][c](b)},this._listenOnce=function(){var a=new Uint8Array(b._analyserNode.frequencyBinCount);b._analyserNode.getByteFrequencyData(a);for(var m=[],n=0;2*c>n;n++){var o=Math.floor((h+n*d-c*d)/audioSignAudioContext.sampleRate*2048);m.push(a[n])}m=m.sort(function(a,b){return a-b});{var p=m[m.length/2],q=m[m.length/4];m[m.length/4*3]}average=Math.max(p/2,q);for(var r=[],n=0;c>n;n++){var o=Math.floor((h+n*d)/audioSignAudioContext.sampleRate*2048);a[o]>average||a[o+1]>average?(i[n]=(i[n]||0)*e+(1-e),r[n]=1):(i[n]=(i[n]||0)*e,r[n]=0),i[n]<.01&&(i[n]=0)}var s=i.map(function(a){return a>f?1:0}),t=AudioSignUtil.binaryArrayToInteger(s);0!=t&&t!=Math.max(2,c)-1&&(t==j?(k++,k>=g&&t!=l&&(l=t,b._emit("candidate",t))):(j=t,k=0))}};AudioSignListener.prototype.on=function(a,b){this._listeners[a]=this._listeners[a]||[],this._listeners[a].push(b)},AudioSignListener.prototype.off=function(a,b){this._listeners[a]&&this._listeners[a].remove(b)},AudioSignListener.prototype.start=function(){function a(a){b._mediaStream=a,b._audioInput=audioSignAudioContext.createMediaStreamSource(b._mediaStream),b._analyserNode=audioSignAudioContext.createAnalyser(),b._analyserNode.fftSize=2048,b._analyserNode.smoothingTimeConstant=0,b._scriptProcessorNode=audioSignAudioContext.createScriptProcessor(1024,1,1),b._scriptProcessorNode.onaudioprocess=function(){b._listenOnce()},b._audioInput.connect(b._analyserNode),b._analyserNode.connect(b._scriptProcessorNode),b._scriptProcessorNode.connect(audioSignAudioContext.destination)}if("Started"==this._state)throw new Error("Already started");this._reset(),this._state="Started";var b=this;navigator.getUserMedia({audio:{optional:[{echoCancellation:!1}]}},a,function(a){throw a})},AudioSignListener.prototype.stop=function(){if("Started"!=this._state)throw new Error("Not started");this._mediaStream.stop(),this._audioInput.disconnect(),this._analyserNode.disconnect(),this._scriptProcessorNode.disconnect(),delete this._mediaStream,delete this._audioInput,delete this._analyserNode,delete this._scriptProcessorNode,delete this._state},navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;var AudioSign={AudioSignBroadcaster:AudioSignBroadcaster,AudioSignListener:AudioSignListener};