function setupTypedArray(a,b){"function"!=typeof this[a]&&"object"!=typeof this[a]&&(this[a]="function"==typeof this[b]&&"object"!=typeof this[b]?this[b]:function(a){return a instanceof Array?a:"number"==typeof a?new Array(a):void 0})}function FourierTransform(a,b){this.bufferSize=a,this.sampleRate=b,this.bandwidth=2/a*b/2,this.spectrum=new Float32Array(a/2),this.real=new Float32Array(a),this.imag=new Float32Array(a),this.peakBand=0,this.peak=0,this.getBandFrequency=function(a){return this.bandwidth*a+this.bandwidth/2},this.calculateSpectrum=function(){for(var b,c,d,e=this.spectrum,f=this.real,g=this.imag,h=2/this.bufferSize,i=Math.sqrt,j=0,k=a/2;k>j;j++)b=f[j],c=g[j],d=h*i(b*b+c*c),d>this.peak&&(this.peakBand=j,this.peak=d),e[j]=d}}function DFT(a,b){FourierTransform.call(this,a,b);var c=a/2*a,d=2*Math.PI;this.sinTable=new Float32Array(c),this.cosTable=new Float32Array(c);for(var e=0;c>e;e++)this.sinTable[e]=Math.sin(e*d/a),this.cosTable[e]=Math.cos(e*d/a)}function FFT(a,b){FourierTransform.call(this,a,b),this.reverseTable=new Uint32Array(a);for(var c,d=1,e=a>>1;a>d;){for(c=0;d>c;c++)this.reverseTable[c+d]=this.reverseTable[c]+e;d<<=1,e>>=1}for(this.sinTable=new Float32Array(a),this.cosTable=new Float32Array(a),c=0;a>c;c++)this.sinTable[c]=Math.sin(-Math.PI/c),this.cosTable[c]=Math.cos(-Math.PI/c)}function RFFT(a,b){FourierTransform.call(this,a,b),this.trans=new Float32Array(a),this.reverseTable=new Uint32Array(a),this.reverseBinPermute=function(a,b){var c,d=this.bufferSize,e=d>>>1,f=d-1,g=1,h=0;a[0]=b[0];do{for(h+=e,a[g]=b[h],a[h]=b[g],g++,c=e<<1;c>>=1,!((h^=c)&c););h>=g&&(a[g]=b[h],a[h]=b[g],a[f-g]=b[f-h],a[f-h]=b[f-g]),g++}while(e>g);a[f]=b[f]},this.generateReverseTable=function(){var a,b=this.bufferSize,c=b>>>1,d=b-1,e=1,f=0;this.reverseTable[0]=0;do{for(f+=c,this.reverseTable[e]=f,this.reverseTable[f]=e,e++,a=c<<1;a>>=1,!((f^=a)&a););f>=e&&(this.reverseTable[e]=f,this.reverseTable[f]=e,this.reverseTable[d-e]=d-f,this.reverseTable[d-f]=d-e),e++}while(c>e);this.reverseTable[d]=d},this.generateReverseTable()}function Sampler(a,b,c,d,e,f,g,h){this.file=a,this.bufferSize=b,this.sampleRate=c,this.playStart=d||0,this.playEnd=e||1,this.loopStart=f||0,this.loopEnd=g||1,this.loopMode=h||DSP.OFF,this.loaded=!1,this.samples=[],this.signal=new Float32Array(b),this.frameCount=0,this.envelope=null,this.amplitude=1,this.rootFrequency=110,this.frequency=550,this.step=this.frequency/this.rootFrequency,this.duration=0,this.samplesProcessed=0,this.playhead=0;var i=document.createElement("AUDIO"),j=this;this.loadSamples=function(a){for(var b=DSP.getChannel(DSP.MIX,a.frameBuffer),c=0;c<b.length;c++)j.samples.push(b[c])},this.loadComplete=function(){j.samples=new Float32Array(j.samples),j.loaded=!0},this.loadMetaData=function(){j.duration=i.duration},i.addEventListener("MozAudioAvailable",this.loadSamples,!1),i.addEventListener("loadedmetadata",this.loadMetaData,!1),i.addEventListener("ended",this.loadComplete,!1),i.muted=!0,i.src=a,i.play()}function Oscillator(a,b,c,d,e){switch(this.frequency=b,this.amplitude=c,this.bufferSize=d,this.sampleRate=e,this.frameCount=0,this.waveTableLength=2048,this.cyclesPerSample=b/e,this.signal=new Float32Array(d),this.envelope=null,parseInt(a,10)){case DSP.TRIANGLE:this.func=Oscillator.Triangle;break;case DSP.SAW:this.func=Oscillator.Saw;break;case DSP.SQUARE:this.func=Oscillator.Square;break;default:case DSP.SINE:this.func=Oscillator.Sine}this.generateWaveTable=function(){Oscillator.waveTable[this.func]=new Float32Array(2048);for(var a=this.waveTableLength/this.sampleRate,b=1/a,c=0;c<this.waveTableLength;c++)Oscillator.waveTable[this.func][c]=this.func(c*b/this.sampleRate)},"undefined"==typeof Oscillator.waveTable&&(Oscillator.waveTable={}),"undefined"==typeof Oscillator.waveTable[this.func]&&this.generateWaveTable(),this.waveTable=Oscillator.waveTable[this.func]}function ADSR(a,b,c,d,e,f){this.sampleRate=f,this.attackLength=a,this.decayLength=b,this.sustainLevel=c,this.sustainLength=d,this.releaseLength=e,this.sampleRate=f,this.attackSamples=a*f,this.decaySamples=b*f,this.sustainSamples=d*f,this.releaseSamples=e*f,this.update=function(){this.attack=this.attackSamples,this.decay=this.attack+this.decaySamples,this.sustain=this.decay+this.sustainSamples,this.release=this.sustain+this.releaseSamples},this.update(),this.samplesProcessed=0}function IIRFilter(a,b,c,d){switch(this.sampleRate=d,a){case DSP.LOWPASS:case DSP.LP12:this.func=new IIRFilter.LP12(b,c,d)}}function IIRFilter2(a,b,c,d){this.type=a,this.cutoff=b,this.resonance=c,this.sampleRate=d,this.f=Float32Array(4),this.f[0]=0,this.f[1]=0,this.f[2]=0,this.f[3]=0,this.calcCoeff=function(a,b){this.freq=2*Math.sin(Math.PI*Math.min(.25,a/(2*this.sampleRate))),this.damp=Math.min(2*(1-Math.pow(b,.25)),Math.min(2,2/this.freq-.5*this.freq))},this.calcCoeff(b,c)}function WindowFunction(a,b){switch(this.alpha=b,a){case DSP.BARTLETT:this.func=WindowFunction.Bartlett;break;case DSP.BARTLETTHANN:this.func=WindowFunction.BartlettHann;break;case DSP.BLACKMAN:this.func=WindowFunction.Blackman,this.alpha=this.alpha||.16;break;case DSP.COSINE:this.func=WindowFunction.Cosine;break;case DSP.GAUSS:this.func=WindowFunction.Gauss,this.alpha=this.alpha||.25;break;case DSP.HAMMING:this.func=WindowFunction.Hamming;break;case DSP.HANN:this.func=WindowFunction.Hann;break;case DSP.LANCZOS:this.func=WindowFunction.Lanczoz;break;case DSP.RECTANGULAR:this.func=WindowFunction.Rectangular;break;case DSP.TRIANGULAR:this.func=WindowFunction.Triangular}}function sinh(a){return(Math.exp(a)-Math.exp(-a))/2}function Biquad(a,b){this.Fs=b,this.type=a,this.parameterType=DSP.Q,this.x_1_l=0,this.x_2_l=0,this.y_1_l=0,this.y_2_l=0,this.x_1_r=0,this.x_2_r=0,this.y_1_r=0,this.y_2_r=0,this.b0=1,this.a0=1,this.b1=0,this.a1=0,this.b2=0,this.a2=0,this.b0a0=this.b0/this.a0,this.b1a0=this.b1/this.a0,this.b2a0=this.b2/this.a0,this.a1a0=this.a1/this.a0,this.a2a0=this.a2/this.a0,this.f0=3e3,this.dBgain=12,this.Q=1,this.BW=-3,this.S=1,this.coefficients=function(){var a=[this.b0,this.b1,this.b2],b=[this.a0,this.a1,this.a2];return{b:a,a:b}},this.setFilterType=function(a){this.type=a,this.recalculateCoefficients()},this.setSampleRate=function(a){this.Fs=a,this.recalculateCoefficients()},this.setQ=function(a){this.parameterType=DSP.Q,this.Q=Math.max(Math.min(a,115),.001),this.recalculateCoefficients()},this.setBW=function(a){this.parameterType=DSP.BW,this.BW=a,this.recalculateCoefficients()},this.setS=function(a){this.parameterType=DSP.S,this.S=Math.max(Math.min(a,5),1e-4),this.recalculateCoefficients()},this.setF0=function(a){this.f0=a,this.recalculateCoefficients()},this.setDbGain=function(a){this.dBgain=a,this.recalculateCoefficients()},this.recalculateCoefficients=function(){var b;b=a===DSP.PEAKING_EQ||a===DSP.LOW_SHELF||a===DSP.HIGH_SHELF?Math.pow(10,this.dBgain/40):Math.sqrt(Math.pow(10,this.dBgain/20));var c=DSP.TWO_PI*this.f0/this.Fs,d=Math.cos(c),e=Math.sin(c),f=0;switch(this.parameterType){case DSP.Q:f=e/(2*this.Q);break;case DSP.BW:f=e*sinh(Math.LN2/2*this.BW*c/e);break;case DSP.S:f=e/2*Math.sqrt((b+1/b)*(1/this.S-1)+2)}var g;switch(this.type){case DSP.LPF:this.b0=(1-d)/2,this.b1=1-d,this.b2=(1-d)/2,this.a0=1+f,this.a1=-2*d,this.a2=1-f;break;case DSP.HPF:this.b0=(1+d)/2,this.b1=-(1+d),this.b2=(1+d)/2,this.a0=1+f,this.a1=-2*d,this.a2=1-f;break;case DSP.BPF_CONSTANT_SKIRT:this.b0=e/2,this.b1=0,this.b2=-e/2,this.a0=1+f,this.a1=-2*d,this.a2=1-f;break;case DSP.BPF_CONSTANT_PEAK:this.b0=f,this.b1=0,this.b2=-f,this.a0=1+f,this.a1=-2*d,this.a2=1-f;break;case DSP.NOTCH:this.b0=1,this.b1=-2*d,this.b2=1,this.a0=1+f,this.a1=-2*d,this.a2=1-f;break;case DSP.APF:this.b0=1-f,this.b1=-2*d,this.b2=1+f,this.a0=1+f,this.a1=-2*d,this.a2=1-f;break;case DSP.PEAKING_EQ:this.b0=1+f*b,this.b1=-2*d,this.b2=1-f*b,this.a0=1+f/b,this.a1=-2*d,this.a2=1-f/b;break;case DSP.LOW_SHELF:g=e*Math.sqrt((3^b)*(1/this.S-1)+2*b),this.b0=b*(b+1-(b-1)*d+g),this.b1=2*b*(b-1-(b+1)*d),this.b2=b*(b+1-(b-1)*d-g),this.a0=b+1+(b-1)*d+g,this.a1=-2*(b-1+(b+1)*d),this.a2=b+1+(b-1)*d-g;break;case DSP.HIGH_SHELF:g=e*Math.sqrt((3^b)*(1/this.S-1)+2*b),this.b0=b*(b+1+(b-1)*d+g),this.b1=-2*b*(b-1+(b+1)*d),this.b2=b*(b+1+(b-1)*d-g),this.a0=b+1-(b-1)*d+g,this.a1=2*(b-1-(b+1)*d),this.a2=b+1-(b-1)*d-g}this.b0a0=this.b0/this.a0,this.b1a0=this.b1/this.a0,this.b2a0=this.b2/this.a0,this.a1a0=this.a1/this.a0,this.a2a0=this.a2/this.a0},this.process=function(a){for(var b=a.length,c=new Float32Array(b),d=0;d<a.length;d++)c[d]=this.b0a0*a[d]+this.b1a0*this.x_1_l+this.b2a0*this.x_2_l-this.a1a0*this.y_1_l-this.a2a0*this.y_2_l,this.y_2_l=this.y_1_l,this.y_1_l=c[d],this.x_2_l=this.x_1_l,this.x_1_l=a[d];return c},this.processStereo=function(a){for(var b=a.length,c=new Float32Array(b),d=0;b/2>d;d++)c[2*d]=this.b0a0*a[2*d]+this.b1a0*this.x_1_l+this.b2a0*this.x_2_l-this.a1a0*this.y_1_l-this.a2a0*this.y_2_l,this.y_2_l=this.y_1_l,this.y_1_l=c[2*d],this.x_2_l=this.x_1_l,this.x_1_l=a[2*d],c[2*d+1]=this.b0a0*a[2*d+1]+this.b1a0*this.x_1_r+this.b2a0*this.x_2_r-this.a1a0*this.y_1_r-this.a2a0*this.y_2_r,this.y_2_r=this.y_1_r,this.y_1_r=c[2*d+1],this.x_2_r=this.x_1_r,this.x_1_r=a[2*d+1];return c}}function GraphicalEq(a){this.FS=a,this.minFreq=40,this.maxFreq=16e3,this.bandsPerOctave=1,this.filters=[],this.freqzs=[],this.calculateFreqzs=!0,this.recalculateFilters=function(){var a=Math.round(Math.log(this.maxFreq/this.minFreq)*this.bandsPerOctave/Math.LN2);this.filters=[];for(var b=0;a>b;b++){var c=this.minFreq*Math.pow(2,b/this.bandsPerOctave),d=new Biquad(DSP.PEAKING_EQ,this.FS);d.setDbGain(0),d.setBW(1/this.bandsPerOctave),d.setF0(c),this.filters[b]=d,this.recalculateFreqz(b)}},this.setMinimumFrequency=function(a){this.minFreq=a,this.recalculateFilters()},this.setMaximumFrequency=function(a){this.maxFreq=a,this.recalculateFilters()},this.setBandsPerOctave=function(a){this.bandsPerOctave=a,this.recalculateFilters()},this.setBandGain=function(a,b){if(0>a||a>this.filters.length-1)throw"The band index of the graphical equalizer is out of bounds.";if(!b)throw"A gain must be passed.";this.filters[a].setDbGain(b),this.recalculateFreqz(a)},this.recalculateFreqz=function(a){if(this.calculateFreqzs){if(0>a||a>this.filters.length-1)throw"The band index of the graphical equalizer is out of bounds. "+a+" is out of [0, "+this.filters.length-1+"]";if(!this.w){this.w=Float32Array(400);for(var b=0;b<this.w.length;b++)this.w[b]=Math.PI/this.w.length*b}var c=[this.filters[a].b0,this.filters[a].b1,this.filters[a].b2],d=[this.filters[a].a0,this.filters[a].a1,this.filters[a].a2];this.freqzs[a]=DSP.mag2db(DSP.freqz(c,d,this.w))}},this.process=function(a){for(var b=a,c=0;c<this.filters.length;c++)b=this.filters[c].process(b);return b},this.processStereo=function(a){for(var b=a,c=0;c<this.filters.length;c++)b=this.filters[c].processStereo(b);return b}}function MultiDelay(a,b,c,d){this.delayBufferSamples=new Float32Array(a),this.delayInputPointer=b,this.delayOutputPointer=0,this.delayInSamples=b,this.masterVolume=c,this.delayVolume=d}function SingleDelay(a,b,c){this.delayBufferSamples=new Float32Array(a),this.delayInputPointer=b,this.delayOutputPointer=0,this.delayInSamples=b,this.delayVolume=c}function Reverb(a,b,c,d,e,f){this.delayInSamples=b,this.masterVolume=c,this.mixVolume=d,this.delayVolume=e,this.dampFrequency=f,this.NR_OF_MULTIDELAYS=6,this.NR_OF_SINGLEDELAYS=6,this.LOWPASSL=new IIRFilter2(DSP.LOWPASS,f,0,44100),this.LOWPASSR=new IIRFilter2(DSP.LOWPASS,f,0,44100),this.singleDelays=[];var g,h;for(g=0;g<this.NR_OF_SINGLEDELAYS;g++)h=1+g/7,this.singleDelays[g]=new SingleDelay(a,Math.round(this.delayInSamples*h),this.delayVolume);for(this.multiDelays=[],g=0;g<this.NR_OF_MULTIDELAYS;g++)h=1+g/10,this.multiDelays[g]=new MultiDelay(a,Math.round(this.delayInSamples*h),this.masterVolume,this.delayVolume)}var DSP={LEFT:0,RIGHT:1,MIX:2,SINE:1,TRIANGLE:2,SAW:3,SQUARE:4,LOWPASS:0,HIGHPASS:1,BANDPASS:2,NOTCH:3,BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10,OFF:0,FW:1,BW:2,FWBW:3,TWO_PI:2*Math.PI};setupTypedArray("Float32Array","WebGLFloatArray"),setupTypedArray("Int32Array","WebGLIntArray"),setupTypedArray("Uint16Array","WebGLUnsignedShortArray"),setupTypedArray("Uint8Array","WebGLUnsignedByteArray"),DSP.invert=function(a){for(var b=0,c=a.length;c>b;b++)a[b]*=-1;return a},DSP.interleave=function(a,b){if(a.length!==b.length)throw"Can not interleave. Channel lengths differ.";for(var c=new Float32Array(2*a.length),d=0,e=a.length;e>d;d++)c[2*d]=a[d],c[2*d+1]=b[d];return c},DSP.deinterleave=function(){var a,b,c,d=[];return d[DSP.MIX]=function(a){for(var b=0,d=a.length/2;d>b;b++)c[b]=(a[2*b]+a[2*b+1])/2;return c},d[DSP.LEFT]=function(b){for(var c=0,d=b.length/2;d>c;c++)a[c]=b[2*c];return a},d[DSP.RIGHT]=function(a){for(var c=0,d=a.length/2;d>c;c++)b[c]=a[2*c+1];return b},function(e,f){return a=a||new Float32Array(f.length/2),b=b||new Float32Array(f.length/2),c=c||new Float32Array(f.length/2),f.length/2!==a.length&&(a=new Float32Array(f.length/2),b=new Float32Array(f.length/2),c=new Float32Array(f.length/2)),d[e](f)}}(),DSP.getChannel=DSP.deinterleave,DSP.mixSampleBuffers=function(a,b,c,d){for(var e=new Float32Array(a),f=0;f<a.length;f++)e[f]+=(c?-b[f]:b[f])/d;return e},DSP.LPF=0,DSP.HPF=1,DSP.BPF_CONSTANT_SKIRT=2,DSP.BPF_CONSTANT_PEAK=3,DSP.NOTCH=4,DSP.APF=5,DSP.PEAKING_EQ=6,DSP.LOW_SHELF=7,DSP.HIGH_SHELF=8,DSP.Q=1,DSP.BW=2,DSP.S=3,DSP.RMS=function(a){for(var b=0,c=0,d=a.length;d>c;c++)b+=a[c]*a[c];return Math.sqrt(b/d)},DSP.Peak=function(a){for(var b=0,c=0,d=a.length;d>c;c++)b=Math.abs(a[c])>b?Math.abs(a[c]):b;return b},DFT.prototype.forward=function(a){for(var b,c,d=this.real,e=this.imag,f=0;f<this.bufferSize/2;f++){b=0,c=0;for(var g=0;g<a.length;g++)b+=this.cosTable[f*g]*a[g],c+=this.sinTable[f*g]*a[g];d[f]=b,e[f]=c}return this.calculateSpectrum()},FFT.prototype.forward=function(a){var b=this.bufferSize,c=this.cosTable,d=this.sinTable,e=this.reverseTable,f=this.real,g=this.imag,h=(this.spectrum,Math.floor(Math.log(b)/Math.LN2));if(Math.pow(2,h)!==b)throw"Invalid buffer size, must be a power of 2.";if(b!==a.length)throw"Supplied buffer is not the same size as defined FFT. FFT Size: "+b+" Buffer Size: "+a.length;var i,j,k,l,m,n,o,p,q,r=1;for(q=0;b>q;q++)f[q]=a[e[q]],g[q]=0;for(;b>r;){i=c[r],j=d[r],k=1,l=0;for(var s=0;r>s;s++){for(q=s;b>q;)m=q+r,n=k*f[m]-l*g[m],o=k*g[m]+l*f[m],f[m]=f[q]-n,g[m]=g[q]-o,f[q]+=n,g[q]+=o,q+=r<<1;p=k,k=p*i-l*j,l=p*j+l*i}r<<=1}return this.calculateSpectrum()},FFT.prototype.inverse=function(a,b){{var c=this.bufferSize,d=this.cosTable,e=this.sinTable,f=this.reverseTable;this.spectrum}a=a||this.real,b=b||this.imag;var g,h,i,j,k,l,m,n,o,p=1;for(o=0;c>o;o++)b[o]*=-1;var q=new Float32Array(c),r=new Float32Array(c);for(o=0;o<a.length;o++)q[o]=a[f[o]],r[o]=b[f[o]];for(a=q,b=r;c>p;){g=d[p],h=e[p],i=1,j=0;for(var s=0;p>s;s++){for(o=s;c>o;)k=o+p,l=i*a[k]-j*b[k],m=i*b[k]+j*a[k],a[k]=a[o]-l,b[k]=b[o]-m,a[o]+=l,b[o]+=m,o+=p<<1;n=i,i=n*g-j*h,j=n*h+j*g}p<<=1}var t=new Float32Array(c);for(o=0;c>o;o++)t[o]=a[o]/c;return t},RFFT.prototype.forward=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B=this.bufferSize,C=this.spectrum,D=this.trans,E=2*Math.PI,F=Math.sqrt,G=B>>>1,H=2/B;this.reverseBinPermute(D,a);for(var I=0,J=4;B>I;J*=4){for(var K=I;B>K;K+=J)r=D[K]-D[K+1],D[K]+=D[K+1],D[K+1]=r;I=2*(J-1)}for(b=2,e=B>>>1;e>>>=1;){I=0,b<<=1,J=b<<1,c=b>>>2,d=b>>>3;do{if(1!==c)for(K=I;B>K;K+=J)j=K,k=j+c,l=k+c,m=l+c,f=D[l]+D[m],D[m]-=D[l],D[l]=D[j]-f,D[j]+=f,j+=d,k+=d,l+=d,m+=d,f=D[l]+D[m],g=D[l]-D[m],f=-f*Math.SQRT1_2,g*=Math.SQRT1_2,r=D[k],D[m]=f+r,D[l]=f-r,D[k]=D[j]-g,D[j]+=g;else for(K=I;B>K;K+=J)j=K,k=j+c,l=k+c,m=l+c,f=D[l]+D[m],D[m]-=D[l],D[l]=D[j]-f,D[j]+=f;I=(J<<1)-b,J<<=2}while(B>I);w=E/b;for(var L=1;d>L;L++){x=L*w,t=Math.sin(x),s=Math.cos(x),u=4*s*(s*s-.75),v=4*t*(.75-t*t),I=0,J=b<<1;do{for(K=I;B>K;K+=J)j=K+L,k=j+c,l=k+c,m=l+c,n=K+c-L,o=n+c,p=o+c,q=p+c,g=D[p]*s-D[l]*t,f=D[p]*t+D[l]*s,i=D[q]*u-D[m]*v,h=D[q]*v+D[m]*u,r=g-i,g+=i,i=r,D[q]=g+D[o],D[l]=g-D[o],r=h-f,f+=h,h=r,D[m]=h+D[k],D[p]=h-D[k],D[o]=D[j]-f,D[j]+=f,D[k]=i+D[n],D[n]-=i;I=(J<<1)-b,J<<=2}while(B>I)}}for(;--G;)y=D[G],z=D[B-G-1],A=H*F(y*y+z*z),A>this.peak&&(this.peakBand=G,this.peak=A),C[G]=A;return C[0]=H*D[0],C},Sampler.prototype.applyEnvelope=function(){return this.envelope.process(this.signal),this.signal},Sampler.prototype.generate=function(){for(var a=(this.frameCount*this.bufferSize,this.playEnd*this.samples.length-this.playStart*this.samples.length),b=this.playStart*this.samples.length,c=this.playEnd*this.samples.length,d=0;d<this.bufferSize;d++){switch(this.loopMode){case DSP.OFF:this.playhead=Math.round(this.samplesProcessed*this.step+b),this.signal[d]=this.playhead<this.playEnd*this.samples.length?this.samples[this.playhead]*this.amplitude:0;break;case DSP.FW:this.playhead=Math.round(this.samplesProcessed*this.step%a+b),this.playhead<this.playEnd*this.samples.length&&(this.signal[d]=this.samples[this.playhead]*this.amplitude);break;case DSP.BW:this.playhead=c-Math.round(this.samplesProcessed*this.step%a),this.playhead<this.playEnd*this.samples.length&&(this.signal[d]=this.samples[this.playhead]*this.amplitude);break;case DSP.FWBW:this.playhead=Math.floor(this.samplesProcessed*this.step/a)%2===0?Math.round(this.samplesProcessed*this.step%a+b):c-Math.round(this.samplesProcessed*this.step%a),this.playhead<this.playEnd*this.samples.length&&(this.signal[d]=this.samples[this.playhead]*this.amplitude)}this.samplesProcessed++}return this.frameCount++,this.signal},Sampler.prototype.setFreq=function(a){var b=this.samplesProcessed*this.step;this.frequency=a,this.step=this.frequency/this.rootFrequency,this.samplesProcessed=Math.round(b/this.step)},Sampler.prototype.reset=function(){this.samplesProcessed=0,this.playhead=0},Oscillator.prototype.setAmp=function(a){if(!(a>=0&&1>=a))throw"Amplitude out of range (0..1).";this.amplitude=a},Oscillator.prototype.setFreq=function(a){this.frequency=a,this.cyclesPerSample=a/this.sampleRate},Oscillator.prototype.add=function(a){for(var b=0;b<this.bufferSize;b++)this.signal[b]+=a.signal[b];return this.signal},Oscillator.prototype.addSignal=function(a){for(var b=0;b<a.length&&!(b>=this.bufferSize);b++)this.signal[b]+=a[b];return this.signal},Oscillator.prototype.addEnvelope=function(a){this.envelope=a},Oscillator.prototype.applyEnvelope=function(){this.envelope.process(this.signal)},Oscillator.prototype.valueAt=function(a){return this.waveTable[a%this.waveTableLength]},Oscillator.prototype.generate=function(){for(var a,b=this.frameCount*this.bufferSize,c=this.waveTableLength*this.frequency/this.sampleRate,d=0;d<this.bufferSize;d++)a=Math.round((b+d)*c),this.signal[d]=this.waveTable[a%this.waveTableLength]*this.amplitude;return this.frameCount++,this.signal},Oscillator.Sine=function(a){return Math.sin(DSP.TWO_PI*a)},Oscillator.Square=function(a){return.5>a?1:-1},Oscillator.Saw=function(a){return 2*(a-Math.round(a))},Oscillator.Triangle=function(a){return 1-4*Math.abs(Math.round(a)-a)},Oscillator.Pulse=function(){},ADSR.prototype.noteOn=function(){this.samplesProcessed=0,this.sustainSamples=this.sustainLength*this.sampleRate,this.update()},ADSR.prototype.noteOff=function(){this.sustainSamples=this.samplesProcessed-this.decaySamples,this.update()},ADSR.prototype.processSample=function(a){var b=0;return this.samplesProcessed<=this.attack?b=0+1*((this.samplesProcessed-0)/(this.attack-0)):this.samplesProcessed>this.attack&&this.samplesProcessed<=this.decay?b=1+(this.sustainLevel-1)*((this.samplesProcessed-this.attack)/(this.decay-this.attack)):this.samplesProcessed>this.decay&&this.samplesProcessed<=this.sustain?b=this.sustainLevel:this.samplesProcessed>this.sustain&&this.samplesProcessed<=this.release&&(b=this.sustainLevel+(0-this.sustainLevel)*((this.samplesProcessed-this.sustain)/(this.release-this.sustain))),a*b},ADSR.prototype.value=function(){var a=0;return this.samplesProcessed<=this.attack?a=0+1*((this.samplesProcessed-0)/(this.attack-0)):this.samplesProcessed>this.attack&&this.samplesProcessed<=this.decay?a=1+(this.sustainLevel-1)*((this.samplesProcessed-this.attack)/(this.decay-this.attack)):this.samplesProcessed>this.decay&&this.samplesProcessed<=this.sustain?a=this.sustainLevel:this.samplesProcessed>this.sustain&&this.samplesProcessed<=this.release&&(a=this.sustainLevel+(0-this.sustainLevel)*((this.samplesProcessed-this.sustain)/(this.release-this.sustain))),a},ADSR.prototype.process=function(a){for(var b=0;b<a.length;b++)a[b]*=this.value(),this.samplesProcessed++;return a},ADSR.prototype.isActive=function(){return this.samplesProcessed>this.release||-1===this.samplesProcessed?!1:!0},ADSR.prototype.disable=function(){this.samplesProcessed=-1},IIRFilter.prototype.__defineGetter__("cutoff",function(){return this.func.cutoff}),IIRFilter.prototype.__defineGetter__("resonance",function(){return this.func.resonance}),IIRFilter.prototype.set=function(a,b){this.func.calcCoeff(a,b)},IIRFilter.prototype.process=function(a){this.func.process(a)},IIRFilter.prototype.addEnvelope=function(a){if(!(a instanceof ADSR))throw"Not an envelope.";this.func.addEnvelope(a)},IIRFilter.LP12=function(a,b,c){this.sampleRate=c,this.vibraPos=0,this.vibraSpeed=0,this.envelope=!1,this.calcCoeff=function(a,b){this.w=2*Math.PI*a/this.sampleRate,this.q=1-this.w/(2*(b+.5/(1+this.w))+this.w-2),this.r=this.q*this.q,this.c=this.r+1-2*Math.cos(this.w)*this.q,this.cutoff=a,this.resonance=b},this.calcCoeff(a,b),this.process=function(a){for(var b=0;b<a.length;b++)this.vibraSpeed+=(a[b]-this.vibraPos)*this.c,this.vibraPos+=this.vibraSpeed,this.vibraSpeed*=this.r,this.envelope?(a[b]=a[b]*(1-this.envelope.value())+this.vibraPos*this.envelope.value(),this.envelope.samplesProcessed++):a[b]=this.vibraPos}},IIRFilter.LP12.prototype.addEnvelope=function(a){this.envelope=a},IIRFilter2.prototype.process=function(a){for(var b,c,d=this.f,e=0;e<a.length;e++)b=a[e],d[3]=b-this.damp*d[2],d[0]=d[0]+this.freq*d[2],d[1]=d[3]-d[0],d[2]=this.freq*d[1]+d[2],c=.5*d[this.type],d[3]=b-this.damp*d[2],d[0]=d[0]+this.freq*d[2],d[1]=d[3]-d[0],d[2]=this.freq*d[1]+d[2],c+=.5*d[this.type],this.envelope?(a[e]=a[e]*(1-this.envelope.value())+c*this.envelope.value(),this.envelope.samplesProcessed++):a[e]=c},IIRFilter2.prototype.addEnvelope=function(a){if(!(a instanceof ADSR))throw"This is not an envelope.";this.envelope=a},IIRFilter2.prototype.set=function(a,b){this.calcCoeff(a,b)},WindowFunction.prototype.process=function(a){for(var b=a.length,c=0;b>c;c++)a[c]*=this.func(b,c,this.alpha);return a},WindowFunction.Bartlett=function(a,b){return 2/(a-1)*((a-1)/2-Math.abs(b-(a-1)/2))},WindowFunction.BartlettHann=function(a,b){return.62-.48*Math.abs(b/(a-1)-.5)-.38*Math.cos(DSP.TWO_PI*b/(a-1))},WindowFunction.Blackman=function(a,b,c){var d=(1-c)/2,e=.5,f=c/2;return d-e*Math.cos(DSP.TWO_PI*b/(a-1))+f*Math.cos(4*Math.PI*b/(a-1))},WindowFunction.Cosine=function(a,b){return Math.cos(Math.PI*b/(a-1)-Math.PI/2)},WindowFunction.Gauss=function(a,b,c){return Math.pow(Math.E,-.5*Math.pow((b-(a-1)/2)/(c*(a-1)/2),2))},WindowFunction.Hamming=function(a,b){return.54-.46*Math.cos(DSP.TWO_PI*b/(a-1))},WindowFunction.Hann=function(a,b){return.5*(1-Math.cos(DSP.TWO_PI*b/(a-1)))},WindowFunction.Lanczos=function(a,b){var c=2*b/(a-1)-1;return Math.sin(Math.PI*c)/(Math.PI*c)},WindowFunction.Rectangular=function(){return 1},WindowFunction.Triangular=function(a,b){return 2/a*(a/2-Math.abs(b-(a-1)/2))},DSP.mag2db=function(a){for(var b=-120,c=Math.pow(10,b/20),d=Math.log,e=Math.max,f=Float32Array(a.length),g=0;g<a.length;g++)f[g]=20*d(e(a[g],c));return f},DSP.freqz=function(a,b,c){var d,e;if(!c)for(c=Float32Array(200),d=0;d<c.length;d++)c[d]=DSP.TWO_PI/c.length*d-Math.PI;var f=Float32Array(c.length),g=Math.sqrt,h=Math.cos,i=Math.sin;for(d=0;d<c.length;d++){var j={real:0,imag:0};for(e=0;e<a.length;e++)j.real+=a[e]*h(-e*c[d]),j.imag+=a[e]*i(-e*c[d]);var k={real:0,imag:0};for(e=0;e<b.length;e++)k.real+=b[e]*h(-e*c[d]),k.imag+=b[e]*i(-e*c[d]);f[d]=g(j.real*j.real+j.imag*j.imag)/g(k.real*k.real+k.imag*k.imag)}return f},MultiDelay.prototype.setDelayInSamples=function(a){this.delayInSamples=a,this.delayInputPointer=this.delayOutputPointer+a,this.delayInputPointer>=this.delayBufferSamples.length-1&&(this.delayInputPointer=this.delayInputPointer-this.delayBufferSamples.length)},MultiDelay.prototype.setMasterVolume=function(a){this.masterVolume=a},MultiDelay.prototype.setDelayVolume=function(a){this.delayVolume=a},MultiDelay.prototype.process=function(a){for(var b=new Float32Array(a.length),c=0;c<a.length;c++){var d=null===this.delayBufferSamples[this.delayOutputPointer]?0:this.delayBufferSamples[this.delayOutputPointer],e=d*this.delayVolume+a[c];this.delayBufferSamples[this.delayInputPointer]=e,b[c]=e*this.masterVolume,this.delayInputPointer++,this.delayInputPointer>=this.delayBufferSamples.length-1&&(this.delayInputPointer=0),this.delayOutputPointer++,this.delayOutputPointer>=this.delayBufferSamples.length-1&&(this.delayOutputPointer=0)}return b},SingleDelay.prototype.setDelayInSamples=function(a){this.delayInSamples=a,this.delayInputPointer=this.delayOutputPointer+a,this.delayInputPointer>=this.delayBufferSamples.length-1&&(this.delayInputPointer=this.delayInputPointer-this.delayBufferSamples.length)},SingleDelay.prototype.setDelayVolume=function(a){this.delayVolume=a},SingleDelay.prototype.process=function(a){for(var b=new Float32Array(a.length),c=0;c<a.length;c++){this.delayBufferSamples[this.delayInputPointer]=a[c];var d=this.delayBufferSamples[this.delayOutputPointer];b[c]=d*this.delayVolume,this.delayInputPointer++,this.delayInputPointer>=this.delayBufferSamples.length-1&&(this.delayInputPointer=0),this.delayOutputPointer++,this.delayOutputPointer>=this.delayBufferSamples.length-1&&(this.delayOutputPointer=0)}return b},Reverb.prototype.setDelayInSamples=function(a){this.delayInSamples=a;var b,c;for(b=0;b<this.NR_OF_SINGLEDELAYS;b++)c=1+b/7,this.singleDelays[b].setDelayInSamples(Math.round(this.delayInSamples*c));for(b=0;b<this.NR_OF_MULTIDELAYS;b++)c=1+b/10,this.multiDelays[b].setDelayInSamples(Math.round(this.delayInSamples*c))},Reverb.prototype.setMasterVolume=function(a){this.masterVolume=a},Reverb.prototype.setMixVolume=function(a){this.mixVolume=a},Reverb.prototype.setDelayVolume=function(a){this.delayVolume=a;var b;for(b=0;b<this.NR_OF_SINGLEDELAYS;b++)this.singleDelays[b].setDelayVolume(this.delayVolume);for(b=0;b<this.NR_OF_MULTIDELAYS;b++)this.multiDelays[b].setDelayVolume(this.delayVolume)},Reverb.prototype.setDampFrequency=function(a){this.dampFrequency=a,this.LOWPASSL.set(a,0),this.LOWPASSR.set(a,0)},Reverb.prototype.process=function(a){var b=new Float32Array(a.length),c=DSP.deinterleave(a);this.LOWPASSL.process(c[DSP.LEFT]),this.LOWPASSR.process(c[DSP.RIGHT]);var d,e=DSP.interleave(c[DSP.LEFT],c[DSP.RIGHT]);for(d=0;d<this.NR_OF_MULTIDELAYS;d++)b=DSP.mixSampleBuffers(b,this.multiDelays[d].process(e),2%d===0,this.NR_OF_MULTIDELAYS);var f=new Float32Array(b.length);for(d=0;d<this.NR_OF_SINGLEDELAYS;d++)f=DSP.mixSampleBuffers(f,this.singleDelays[d].process(b),2%d===0,1);for(d=0;d<f.length;d++)f[d]*=this.mixVolume;for(b=DSP.mixSampleBuffers(f,a,0,1),d=0;d<b.length;d++)b[d]*=this.masterVolume;return b};var AudioSignUtil={hex2bin:function(a,b){for(var c="",d={0:"0000",1:"0001",2:"0010",3:"0011",4:"0100",5:"0101",6:"0110",7:"0111",8:"1000",9:"1001",a:"1010",b:"1011",c:"1100",d:"1101",e:"1110",f:"1111",A:"1010",B:"1011",C:"1100",D:"1101",E:"1110",F:"1111"},e=0;e<a.length;e++)c+=d[a[e]];for(;b&&c.length<b;)c="0"+c;return c},bin2hex:function(a,b){for(var c="",d=0;d<a.length;d+=4){var e=a.substring(d,d+4),f=parseInt(e,2);c+=f.toString(16)}for(;b&&c.length<b/4;)c="0"+c;return c},randomBinary:function(a){for(var b="",c=0;a>c;c++)b+=Math.round(1*Math.random());return b}},AudioSignBroadcaster=function(a){var b=this;a=a||{};var c=a.size||64,d=a.step||35,e=a.baseFrequency||18600-d*c;this.binaryId=AudioSignUtil.hex2bin(a.id||AudioSignUtil.bin2hex(AudioSignUtil.randomBinary(c)),c),this.id=AudioSignUtil.bin2hex(this.binaryId),window.AudioContext=window.AudioContext||window.webkitAudioContext,window.audioSignAudioContext=window.audioSignAudioContext||new window.AudioContext,this._startBuffer=function(){b._sound=audioSignAudioContext.createBufferSource(),b._sound.loop=!0,b._sound.connect(audioSignAudioContext.destination);for(var a=1*audioSignAudioContext.sampleRate,f=audioSignAudioContext.createBuffer(1,a,audioSignAudioContext.sampleRate),g=f.getChannelData(0),h=0,i=0;c>i;i++)if(this.binaryId[i]>0){h+=1;for(var j=0;a>j;j++)g[j]+=Math.sin(2*Math.PI*(e+i*d)*j/audioSignAudioContext.sampleRate)}for(var i=0;a>i;i++)g[i]/=h;b._sound.buffer=f,b._sound.start(0)}};AudioSignBroadcaster.prototype.start=function(){if("Started"==this._state)throw new Error("Already started");this._state="Started",this._startBuffer()},AudioSignBroadcaster.prototype.stop=function(){if("Started"!=this._state)throw new Error("Not started");this._sound.stop(),delete this._sound,delete this._state};var AudioSignListener=function(a){var b=this;a=a||{};var c=a.size||64,d=a.step||35;b.bufferSize=4096;var e=a.diminishingFactor||.9,f=a.threshold||.2,g=a.candidateFoundStreak||12,h=18600-d*c||a.baseFrequency;this._listeners={},window.AudioContext=window.AudioContext||window.webkitAudioContext,window.audioSignAudioContext=window.audioSignAudioContext||new window.AudioContext;var i,j,k,l;this._reset=function(){i=[],j=void 0,k=0,l=void 0},this._emit=function(a,b){for(var c in this._listeners[a])this._listeners[a][c]&&this._listeners[a][c](b)},this._listenOnce=function(a){for(var m=a,n=[],o=0;2*c>o;o++){var p=Math.floor((h+o*d-c*d)/audioSignAudioContext.sampleRate*b.bufferSize);n.push(m[p])}n=n.sort(function(a,b){return a-b});var q=n[Math.floor(n.length/2-1)],r=(n[Math.floor(n.length/4-1)],n[Math.floor(n.length/4*3-1)]),s=n[n.length-1];average=q/18*17+s/18*1+r/18*0;for(var t=[],u=!0,o=0;c>o;o++){var p=Math.floor((h+o*d)/audioSignAudioContext.sampleRate*b.bufferSize);m[p]>average?(i[o]=(i[o]||0)*e+(1-e),t[o]=1):(i[o]=(i[o]||0)*e,t[o]=0,i[o]-=.05),i[o]<.01&&(i[o]=0)}var v=i.map(function(a){return a>f?(u=!1,1):0});if(!u)if(j=j||[],v.toString()==j.toString()){if(k++,k>=g&&(l=l||[],v.toString()!=l.toString())){l=v;var w=AudioSignUtil.bin2hex(v.join(""));b._emit("candidate",w)}}else j=v,k=0}};AudioSignListener.prototype.on=function(a,b){this._listeners[a]=this._listeners[a]||[],this._listeners[a].push(b)},AudioSignListener.prototype.off=function(a,b){this._listeners[a]&&this._listeners[a].remove(b)},AudioSignListener.prototype.start=function(){function a(a){b._mediaStream=a,b._audioInput=audioSignAudioContext.createMediaStreamSource(b._mediaStream),b._scriptProcessorNode=audioSignAudioContext.createScriptProcessor(b.bufferSize,1,1),b._scriptProcessorNode.onaudioprocess=function(a){for(var c=a.inputBuffer.getChannelData(0),d=0;d<c.length;++d)c[d]*=WindowFunction.Hamming(c.length,d);b._fft.forward(c),b._listenOnce(b._fft.spectrum)},b._audioInput.connect(b._scriptProcessorNode),b._scriptProcessorNode.connect(audioSignAudioContext.destination),b._fft=new FFT(b.bufferSize,44100),b._emit("started")}if("Started"==this._state)throw new Error("Already started");this._reset(),this._state="Started";var b=this;navigator.getUserMedia({audio:{optional:[{echoCancellation:!1}]}},a,function(a){throw a})},AudioSignListener.prototype.stop=function(){if("Started"!=this._state)throw new Error("Not started");this._mediaStream.stop(),this._audioInput.disconnect(),this._scriptProcessorNode.disconnect(),delete this._mediaStream,delete this._audioInput,delete this._scriptProcessorNode,delete this._state,_this._emit("stopped")},navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;var AudioSign={AudioSignBroadcaster:AudioSignBroadcaster,AudioSignListener:AudioSignListener};